(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{484:function(s,a,n){"use strict";n.r(a);var e=n(2),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一、playbook介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、playbook介绍"}},[s._v("#")]),s._v(" 一、playbook介绍")]),s._v(" "),a("p",[s._v("playbook(剧本): 是ansible用于配置,部署,和管理被控节点的剧本。")]),s._v(" "),a("p",[s._v("参考:https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html")]),s._v(" "),a("p",[s._v("使用的格式为"),a("strong",[s._v("yaml")]),s._v("格式（saltstack,elk,docker等也都会用到yaml格式)")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("树明的理解：\nplaybook：ansible格式的脚本。将所有需要执行的操作按照ansible的编程语法，放到文件中执行。\n\nplaybook替代方案\n1)、完全可以用shell脚本来替代playbook\n    将所有的ansible命令放入脚本    shell脚本中写的是ansible指令\n#!/bin/bash\nfor IP in  `seq 201 203`\n   do\n       ansible -m hostname 192.168.98.$IP -a \"name=node${IP}\"\ndone\n    \n2)、ansible+shell脚本  使用script模块\nansible -m script group2 '/etc/ansible/srcipts/nginx_install.sh'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h3",{attrs:{id:"_1-1、yaml格式规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1、yaml格式规则"}},[s._v("#")]),s._v(" 1.1、YAML格式规则")]),s._v(" "),a("ul",[a("li",[s._v('文件的第一行以 "—"开始，表明YMAL文件的开始.')]),s._v(" "),a("li",[s._v("以#号开头为注释")]),s._v(" "),a("li",[s._v("列表中的所有成员都开始于相同的缩进级别, 并且使用一个 "),a("code",[s._v('"- "')]),s._v(" 作为开头(一个横杠和一个空格)")]),s._v(" "),a("li",[s._v("一个字典是由一个简单的 "),a("code",[s._v("键: 值")]),s._v(" 的形式组成(这个冒号后面必须是一个空格)")]),s._v(" "),a("li",[a("strong",[s._v("注意: 写这种文件不要使用tab键，都使用空格")])])]),s._v(" "),a("p",[s._v("参考: https://docs.ansible.com/ansible/latest/reference_appendices/YAMLSyntax.html#yaml-syntax")]),s._v(" "),a("p",[s._v("下面看一个官方的示例感受一下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("---\n# 一位职工记录\nname: Example Developer\njob: Developer\nskill: Elite\nemployed: True\nfoods:\n  - Apple\n  - Orange\n  - Strawberry\n  - Mango\nlanguages:\n    ruby: Elite\n    python: Elite\n    dotnet: Lame\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"playbook实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#playbook实例"}},[s._v("#")]),s._v(" playbook实例")]),s._v(" "),a("p",[s._v("先直接来看一个实例 apache安装及业务初始化")]),s._v(" "),a("p",[a("strong",[s._v("第1步: 创建一个存放playbook的目录(路径自定义)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 ~]# mkdir -p /etc/ansible/playbook/web\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("第2步: 准备httpd配置文件,并修改成你想要的配置")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 ~]#  yum install httpd -y\n\n按需要修改你想要的配置(为了测试可以随意改动标记一下)\n[root@manage01 ~]#  vim /etc/httpd/conf/httpd.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("第3步: 写一个playbook文件(后缀为.yml或.yaml)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 web]# cat apache.yaml \n---\n- hosts: group1\n  remote_user: root\n  vars:\n    - user: zutuanxue\n  tasks:\n    - name: create user use variable\n      user: user=zutuanxue state=present\n\n    - name: install httpd server\n      yum: name={{item}} state=latest\n      with_items:\n        - httpd\n        - httpd-devel\n\n    - name: start httpd service\n      service: name=httpd state=started enabled=yes\n\n    - name: copy httpd.conf to group1:/etc/httpd/conf/\n      copy: src=/etc/ansible/playbook/web/httpd.conf dest=/etc/httpd/conf\n      notify:\n        - restart httpd service\n\n  handlers:\n       - name: restart httpd service\n         service: name=httpd state=restarted\n         \n         \n         \n#tasks\n#1、创建apache管理用户\n#2、安装httpd\n#3、服务启动管理\n#4、拷贝配置文件，业务初始化\n   #5、触发重启服务httpd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br")])]),a("p",[s._v("第4步: 执行写好的palybook")]),s._v(" "),a("ul",[a("li",[s._v("会显示出执行的过程，并且执行的每一步都有ok,changed,failed等标识")]),s._v(" "),a("li",[s._v("执行如果有错误(failed)会回滚，解决问题后，直接再执行这条命令即可,并会把failed改为changed（幂等性)")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 web]# ansible-playbook /etc/ansible/playbook/web/apache.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_1-2、playbook常见语法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2、playbook常见语法"}},[s._v("#")]),s._v(" 1.2、Playbook常见语法")]),s._v(" "),a("p",[a("strong",[s._v("hosts:")]),s._v(" 用于指定要执行任务的主机，其可以是一个或多个由冒号分隔主机组.")]),s._v(" "),a("p",[a("strong",[s._v("remote_user:")]),s._v(" 用于指定远程主机上的执行任务的用户.")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- hosts: group1\t\t\t\n  remote_user: root\t\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("tasks:")]),s._v(" 任务列表, 按顺序执行任务.")]),s._v(" "),a("ul",[a("li",[s._v("如果一个host执行task失败, 整个tasks都会回滚, 修正playbook 中的错误, 然后重新执行即可.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("tasks:\n  - name: create user use variable\n    user: name={{user}} state=present\n\n  - name: install httpd server\n    yum: name=httpd state=latest name=httpd-devel state=latest\n\n  - name: start httpd service\n    service: name=httpd state=started enabled=yes\n\n  - name: copy httpd.conf to group1:/etc/httpd/conf/\n    copy: src=/opt/httpd.conf dest=/etc/httpd/conf/\n    \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("strong",[s._v("handlers:")]),s._v(" 类似task，但需要使用notify通知调用，实现按需调用。")]),s._v(" "),a("ul",[a("li",[s._v("不管有多少个通知者进行了notify，等到play中的所有task执行完成之后，handlers也只会被执行一次.")]),s._v(" "),a("li",[s._v("handlers最佳的应用场景是用来重启服务,或者触发系统重启操作.除此以外很少用到了.")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    notify:\n    - restart httpd service\n    \n  handlers:\n    - name: restart httpd service\n      service: name=httpd state=restarted\n      \n  #注意: handlers 需要notify调用，他和tasks不同的是  tasks每次都会调用，heandlers触发才调用，比如配置文件修改了，在执行playbook的时候，就会将管理机上的新改的copy到被管理机，那么就会触发headlers重启服务，否则不会执行heanlers\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("练习:")]),s._v(" 修改httpd的端口为8080,再执行playbook测试")]),s._v(" "),a("p",[a("strong",[s._v("variables:")]),s._v(" 变量")]),s._v(" "),a("ul",[a("li",[s._v("定义变量可以被多次方便调用")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("vars:\n    - user: zutuanxue\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("with_items")]),s._v(": 迭代列表")]),s._v(" "),a("ul",[a("li",[s._v("其使用格式为将需要迭代的内容定义为item变量引用，并通过with_items语句指明迭代的元素列表即可。")])]),s._v(" "),a("p",[s._v("例如安装多个软件包")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("yum: name={{item}} state=latest\nwith_items:\n  - httpd\n  - httpd-devel\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("执行后有如下警告")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.zutuanxue.com:8000/static/media/images/2020/10/6/1601969382005.png",alt:"警告.png"}})]),s._v(" "),a("p",[s._v("解决方法:")]),s._v(" "),a("p",[s._v("在/etc/ansible/ansible.cfg配置文件里的[default]配置段下面加上deprecation_warnings=False参数即可")]),s._v(" "),a("h2",{attrs:{id:"二、练习案例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、练习案例"}},[s._v("#")]),s._v(" 二、练习案例")]),s._v(" "),a("p",[s._v("写一个playbook实现")]),s._v(" "),a("ol",[a("li",[s._v("配置yum")]),s._v(" "),a("li",[s._v("安装vsftpd包")]),s._v(" "),a("li",[s._v("修改配置文件(要求拒绝匿名用户登录)")]),s._v(" "),a("li",[s._v("启动服务并实现vsftpd服务开机自动启动")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("---\n- hosts: group1                 \n  remote_user: root                     \n  tasks:                                \n  - name: rm yum repository      \n    file: path=/etc/yum.repos.d/ state=absent\n    \n  - name: 同步master上的yum源到group1\n    copy: src=/etc/yum.repos.d dest=/etc/\n    \n  - name: ensure vsftpd is at the latest version        \n    yum: name=vsftpd state=latest\n    \n  - name: write the apache config file          \n    copy: src=/etc/vsftpd/vsftpd.conf dest=/etc/vsftpd/vsftpd.conf \n    \n    notify:                             \n    - restart vsftpd\n    \n  - name: ensure vsftpd is running (and enable it at boot)\n    service: name=vsftpd state=started enabled=yes\n    \n  handlers:                     \n    - name: restart vsftpd              \n      service: name=vsftpd state=restarted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);