(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{469:function(s,a,n){"use strict";n.r(a);var e=n(2),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("假设我们要写一个playbook来安装管理lamp环境，那么这个playbook就会写很长。所以我们希望把这个很大的文件分成多个功能拆分, 分成apache管理,php管理,mysql管理，然后在需要使用的时候直接调用就可以了，以免重复写。就类似编程里的模块化的概念，以达到代码复用的效果。")]),s._v(" "),a("h2",{attrs:{id:"一、roles介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、roles介绍"}},[s._v("#")]),s._v(" 一、roles介绍")]),s._v(" "),a("p",[a("strong",[s._v("roles：")]),s._v(" ansible模块，类似于函数，完成一个任务的指令。每一个roles都有自己特定的目录结构，就是通过分别将variables, tasks及handlers等放置于单独的目录中,并可以便捷地调用它们的一种机制。")]),s._v(" "),a("p",[a("strong",[s._v("roles优点：")])]),s._v(" "),a("p",[s._v("1）模块中指令较少，方便编写")]),s._v(" "),a("p",[s._v("2）重复调用方便")]),s._v(" "),a("p",[s._v("3）排错方便")]),s._v(" "),a("h2",{attrs:{id:"二、创建roles的目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、创建roles的目录结构"}},[s._v("#")]),s._v(" 二、创建roles的目录结构")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("files：用来存放由copy模块或script模块调用的文件。\ntasks：至少有一个main.yml文件，定义各tasks。\nhandlers:有一个main.yml文件，定义各handlers。\ntemplates：用来存放jinjia2模板。\nvars：有一个main.yml文件，定义变量。\nmeta：有一个main.yml文件，定义此角色的特殊设定及其依赖关系。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("strong",[s._v("注意:")]),s._v(" 在每个角色的目录中分别创建files, tasks,handlers,templates,vars和meta目录，用不到的目录可以创建为空目录.")]),s._v(" "),a("h2",{attrs:{id:"三、案例-通过roles实现lamp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、案例-通过roles实现lamp"}},[s._v("#")]),s._v(" 三、案例：通过roles实现lamp")]),s._v(" "),a("p",[s._v("分析：需定制三个角色: httpd,mysql,php")]),s._v(" "),a("h3",{attrs:{id:"_3-1-创建roles目录及文件-并确认目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-创建roles目录及文件-并确认目录结构"}},[s._v("#")]),s._v(" 3.1） 创建roles目录及文件,并确认目录结构")]),s._v(" "),a("p",[s._v("roles/\n├── httpd\n│ ├── files\n│ ├── handlers\n│ │ └── main.yml\n│ ├── meta\n│ │ └── main.yml\n│ ├── tasks\n│ │ └── main.yml\n│ ├── templates\n│ └── vars\n│ └── main.yml\n├── mysql\n│ ├── files\n│ ├── handlers\n│ │ └── main.yml\n│ ├── meta\n│ │ └── main.yml\n│ ├── tasks\n│ │ └── main.yml\n│ ├── templates\n│ └── vars\n│ └── main.yml\n└── php\n├── files\n├── handlers\n│ └── main.yml\n├── meta\n│ └── main.yml\n├── tasks\n│ └── main.yml\n├── templates\n└── vars\n└── main.yml")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 ansible]# mkdir -p roles/{httpd,mysql,php}/{files,tasks,handlers,templates,vars,meta}\n[root@manage01 ansible]# touch roles/{httpd,mysql,php}/{tasks,handlers,vars,meta}/main.yml\n[root@manage01 ansible]# tree roles/\nroles/\n├── httpd\n│   ├── files\n│   ├── handlers\n│   │   └── main.yml\n│   ├── meta\n│   │   └── main.yml\n│   ├── tasks\n│   │   └── main.yml\n│   ├── templates\n│   └── vars\n│       └── main.yml\n├── mysql\n│   ├── files\n│   ├── handlers\n│   │   └── main.yml\n│   ├── meta\n│   │   └── main.yml\n│   ├── tasks\n│   │   └── main.yml\n│   ├── templates\n│   └── vars\n│       └── main.yml\n└── php\n    ├── files\n    ├── handlers\n    │   └── main.yml\n    ├── meta\n    │   └── main.yml\n    ├── tasks\n    │   └── main.yml\n    ├── templates\n    └── vars\n        └── main.yml\n\n21 directories, 12 files\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("h3",{attrs:{id:"_3-2-准备httpd服务器的主页文件-php测试页和配置文件等"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-准备httpd服务器的主页文件-php测试页和配置文件等"}},[s._v("#")]),s._v(" 3.2）准备httpd服务器的主页文件,php测试页和配置文件等")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 files]# ls\nhttpd.conf  phpinfo.php\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_3-3-编写httpd角色的main-yml文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-编写httpd角色的main-yml文件"}},[s._v("#")]),s._v(" 3.3）编写httpd角色的main.yml文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 roles]# cat httpd/tasks/main.yml \n- name: httpd httpd-devel httpd-manual软件包安装\n  yum: name={{item}} state=latest\n  with_items:\n    - httpd\n    - httpd-devel\n    - httpd-manual\n\n- name: 创建apache管理用户 www\n  user: name={{user}} state=present\n\n\n- name: 设置apache开机启动，并启动服务\n  service: name=httpd enabled=yes state=started\n\n- name: 拷贝配置文件，初始化业务\n  copy: src=/etc/ansible/roles/httpd/files/httpd.conf dest=/etc/httpd/conf/httpd.conf\n  #定义通知调用，当配置文件更新,需要重启服务\n  notify: \n    - restart apache\n\n- name: 拷贝php测试页面\n  copy: src=/etc/ansible/roles/httpd/files/phpinfo.php dest=/var/www/html/\n\n[root@manage01 roles]# cat httpd/vars/main.yml\nuser: www\n\n\n[root@manage01 roles]# cat httpd/handlers/main.yml \n- name: restart apache\n  service: name=httpd state=restarted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h3",{attrs:{id:"_3-4-编写mysql角色的main-yml文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-编写mysql角色的main-yml文件"}},[s._v("#")]),s._v(" 3.4）编写mysql角色的main.yml文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 ansible]# ls roles/php/files/\nwww.conf\n\n[root@manage01 roles]# cat mysql/tasks/main.yml \n- name: mysql 用户创建\n  user: name={{user}} state=present\n\n- name: mysql 软件安装\n  yum: name={{item}} state=latest\n  with_items:\n    - mariadb\n    - mariadb-server\n\n- name: 启动服务，并设置开机启动\n  service: name=mariadb enabled=yes state=started\n\n- name: 改变mysql文件的所有者为mysql\n  file: path='/usr/lib/mysql' owner={{user}} group={{user}} recurse=yes\n\n\n[root@manage01 roles]# cat mysql/vars/main.yml \nuser: mysql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_3-5-编写php角色的main-yml文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-编写php角色的main-yml文件"}},[s._v("#")]),s._v(" 3.5）:编写php角色的main.yml文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 ansible]# cat roles/php/tasks/main.yml \n- name: 安装php\n  yum: name={{item}} state=latest\n  with_items:\n    - php\n    - php-mysqlnd\n    - php-gd\n    - php-ldap\n    - php-odbc\n    - php-pear\n    - php-xml\n    - php-xmlrpc\n    - php-mbstring\n    - php-snmp\n    - php-soap\n    - curl\n    - curl-devel \n    - php-bcmath\n    - php-fpm\n\n- name: copy www.conf to /etc/php-fpm.d\n  copy: src=/etc/ansible/roles/php/files/www.conf dest=/etc/php-fpm.d force=yes\n  notify:\n    - restart php-fpm\n\n\n[root@manage01 ansible]# cat roles/php/handlers/main.yml \n- name: restart php-fpm\n  service: name=php-fpm state=restarted\n    \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("h3",{attrs:{id:"_3-6-编写lamp的playbook文件调用前面定义好的三个角色"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-编写lamp的playbook文件调用前面定义好的三个角色"}},[s._v("#")]),s._v(" 3.6）编写lamp的playbook文件调用前面定义好的三个角色")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 yaml]# cat lamp.yml \n---\n- hosts: group1\n  remote_user: root\n  roles:\n  - httpd\n  - mysql\n  - php\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"_3-7-执行lamp的playbook文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-执行lamp的playbook文件"}},[s._v("#")]),s._v(" 3.7） 执行lamp的playbook文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[root@manage01 yaml]# ansible-playbook -C lamp.yml\n[root@manage01 yaml]# ansible-playbook lamp.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_3-8-测试业务机器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-测试业务机器"}},[s._v("#")]),s._v(" 3.8） 测试业务机器")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.zutuanxue.com:8000/static/media/images/2020/10/6/1601969569380.png",alt:"lamp_test.png"}})])])}),[],!1,null,null,null);a.default=t.exports}}]);